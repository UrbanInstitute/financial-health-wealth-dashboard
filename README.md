# Financial Health and Wealth Dashboard

This repo contains the code for the data tool [Financial Health and Wealth Dashboard](https://apps.urban.org/features/financial-health-wealth-dashboard/). This tool allows users to view various financial health metrics for Public Use Microdata Areas (PUMAs) and selected cities.

The feature uses Mapbox to power the map and `tippecanoe` and some d3 cartography modules to generate the mbtiles for the map.

## How to run
To run this application, either clone this repo using `git clone` or download the zip file with all of the code. Then fire up a local server (e.g., Python `http.server`, node `http-server`) and open `index.html`.

## Data inputs
The following files are sourced as inputs for the tool:
- In a subdirectory called `final_financial_health_and_wealth_dashboard_results_2022`:
  - `city_asset.csv`, `state_asset.csv`, `usa_asset.csv` - these files contain data on assets disaggregated by race and ethnicity for cities, states, and the US
  - `city_credit.csv`, `state_credit.csv`, `usa_credit.csv` - these files contain data on credit disaggregated by race and ethnicity for cities, states, and the US
  - `puma_v2.csv` - this file contains data on all financial metrics by PUMA
  - `city_racial_compositions.csv`, `puma_racial_compositions_final_v2.csv`, `state_racial_compositions.csv`, `usa_racial_compositions.csv` - these files contain data on population composition by race and ethnicity for cities, PUMAs, states, and the US
- `puma_zipcode_crosswalk_v2.xlsx` - this file maps PUMAs to zip codes and is used to associate one with the other for the searchbox. 
- `cities.geojson` and `pumas.geojson` - two geojson files with the bounding boxes for cities and PUMAs. This is used in the map to display cities and PUMAs.

## Data processing scripts
1. `makeData.R` - this script ingests the source files in the section above and outputs csv files with racial composition data, financial metrics data for PUMAs, cities, states, and the US, data needed for the searchbox, and data mapping PUMAs to cities and zip codes. It also outputs two geojson files (one for cities and one for PUMAs) that defines the boundaries of each and for PUMAs, binds the financial metrics data to each PUMA so it can be used to fill in the map in the tool. This file also calculates the color breaks for the map using Jenks nautral breaks.
    - Inputs: `city_asset.csv`, `state_asset.csv`, `usa_asset.csv`, `city_credit.csv`, `state_credit.csv`, `usa_credit.csv`, `puma_v2.csv`, `city_racial_compositions.csv`, `puma_racial_compositions_final_v2.csv`, `state_racial_compositions.csv`, `usa_racial_compositions.csv`, `puma_zipcode_crosswalk_v2.xlsx`, `cities.geojson`, `pumas.geojson` 
    - Outputs: `racial_comp_data.csv`, `metrics_all.csv`, `city_state_us_racial_metrics.csv`, `search_data.csv`, `puma_city_state_mapping.csv`, `pumas_zipcode.csv`, `cities_4326.geojson`, `pumas_4326.geojson`
2. `makeMaptiles.sh` - this script generates the mbtiles for Mapbox to ensure the data are available for all of the zoom levels we need. The mbtiles set for the PUMAs has all of the financial metrics data associated with each PUMA. It also adds a top-level numeric identifier for each PC or region/country which is needed to allow individual geographies to be highlighted when mousedover on the map.
    - Inputs: `pumas_4326.geojson`, `cities_4326.geojson`
    - Outputs: `pumas-id.mbtiles`, `cities-id.mbtiles`
3. `reshapeGeojsons.py` - this script returns a json file with the calculated bounding box for each PC and region/country. This is needed to tell Mapbox where to shift the map to after the user selects a PUMA or searches for a city or zip code.
    - Inputs: `pumas-id.json`, `cities-id.json`
    - Outputs: `pumas_bboxes.json`, `cities.json`


## How to update
1. First run `makeData.R` from within the `\data` directory. The outputs generated by this script are taken as inputs to `makeMaptiles.sh`. Save the input files, which are provided by the research team, in a subdirectory inside your `\data` directory called `\source`. Save the csv files in a subdirectory inside your `\data\source` directory called `\final_financial_health_and_wealth_dashboard_results_2022`.
2. Run `makeMaptiles.sh` from within the `\data` directory. Upload the two .mbtiles files to [Mapbox](https://studio.mapbox.com/) to the tilesets specified in this script.
(Note: `reshapeGeojsons.py` shouldn't need to be rerun unless the boundaries of the PUMAs or cities has changed.)
3. Commit any changes to either the `development` branch or create a new branch. Then open a PR to merge that branch into `staging`. If there are no errors, the CI/CD should automatically deploy to the staging site. 
4. If changes look good on staging, update the live site by opening a PR to merge `staging` into `main`.
